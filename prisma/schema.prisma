generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  user_id       Int      @id @default(autoincrement())
  username      String   @unique
  email         String   @unique
  password_hash String?
  region        String?
  role          String?
  interests     Json
  referralCode  String?
  referred_by   Int?
  is_verified   Boolean  @default(false)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  refresh_token String?  // ✅ note the snake_case

  // OTP and reset password fields
  otp                    String?
  otp_expires            DateTime?
  reset_password_token    String?
  reset_password_expires  DateTime?

  profile       UserProfile?
  userRoles     UserRole[]   @relation("UserToRoles") // ✅ renamed
  assignedRoles UserRole[]   @relation("AssignedByUser") // ✅ new name for roles this user assigned

  templates     Template[]       @relation("TemplatesCreator")
  purchases     Purchase[]       @relation("BuyerPurchases")
  reviews       Review[]
  aiSessions    AiEditSession[]
  payouts       Payout[]         @relation("AuthorPayout")
  downloads     Download[]
  shares        Share[]
  analytics     AnalyticsEvent[]
  referralCodes ReferralCode[]

  referredBy User?  @relation("Referral", fields: [referred_by], references: [user_id])
  referrals  User[] @relation("Referral")

  authoredTeamMembers     AuthorTeamMember[] @relation("AuthorToMembers")
  memberOfAuthorTeams     AuthorTeamMember[] @relation("MemberOfAuthors")
  administeredTeamMembers AdminTeamMember[]  @relation("AdminToMembers")
  memberOfAdminTeams      AdminTeamMember[]  @relation("MemberOfAdmins")

  refunds Refund[] @relation("RefundRequester")
}

model UserProfile {
  profile_id   Int      @id @default(autoincrement())
  user_id      Int      @unique
  first_name   String?
  last_name    String?
  bio          String?
  avatar_url   String?
  social_links Json?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  user User @relation(fields: [user_id], references: [user_id])
}

model Role {
  role_id     Int        @id @default(autoincrement())
  name        String     @unique
  description String?
  users       UserRole[]
}

model UserRole {
  user_id     Int
  role_id     Int
  assigned_by Int?
  assigned_at DateTime @default(now())

  user       User  @relation("UserToRoles", fields: [user_id], references: [user_id]) // ✅ explicit relation name
  assignedBy User? @relation("AssignedByUser", fields: [assigned_by], references: [user_id])
  role       Role  @relation(fields: [role_id], references: [role_id])

  @@id([user_id, role_id])
}

model Category {
  category_id Int        @id @default(autoincrement())
  name        String     @unique
  slug        String     @unique
  description String?
  templates   Template[]
}

model Template {
  template_id     String   @id @default(uuid())
  creator_id      Int
  title           String
  category_id     Int?
  description     String?
  type            String
  price           Decimal
  is_featured     Boolean  @default(false)
  usability_score Float?
  stack           String[]
  downloads_count Int      @default(0)
  users_count     Int      @default(0)
  avg_rating      Float?
  example_links   Json?
  status          String   @default("draft")
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  creator         User                    @relation("TemplatesCreator", fields: [creator_id], references: [user_id])
  category        Category?               @relation(fields: [category_id], references: [category_id])
  media           TemplateMedia[]
  usecases        TemplateUsecase[]
  tags            TemplateTagOnTemplate[]
  relatedBase     RelatedTemplates[]      @relation("RelatedTemplateBase") // templates this one relates to (as base)
  relatedRelated  RelatedTemplates[]      @relation("RelatedTemplateRelated") // templates that list this as related
  purchases       Purchase[]
  reviews         Review[]
  edits           AiEditSession[]
  logs            TemplateUpdateLog[]
  downloads       Download[]
  shares          Share[]
  analyticsEvents AnalyticsEvent[]
}

model TemplateMedia {
  media_id    String @id @default(uuid())
  template_id String
  media_type  String
  url         String
  order_index Int?

  template Template @relation(fields: [template_id], references: [template_id])
}

model TemplateUsecase {
  usecase_id  Int     @id @default(autoincrement())
  template_id String
  title       String
  description String?

  template Template @relation(fields: [template_id], references: [template_id])
}

model TemplateTag {
  tag_id    Int                     @id @default(autoincrement())
  name      String                  @unique
  templates TemplateTagOnTemplate[]
}

model TemplateTagOnTemplate {
  template_id String
  tag_id      Int

  template Template    @relation(fields: [template_id], references: [template_id])
  tag      TemplateTag @relation(fields: [tag_id], references: [tag_id])

  @@id([template_id, tag_id])
}

model RelatedTemplates {
  base_template_id    String
  related_template_id String

  base_template    Template @relation("RelatedTemplateBase", fields: [base_template_id], references: [template_id])
  related_template Template @relation("RelatedTemplateRelated", fields: [related_template_id], references: [template_id])

  @@id([base_template_id, related_template_id])
}

model TemplateUpdateLog {
  log_id      Int      @id @default(autoincrement())
  template_id String
  version     String
  changelog   String
  updated_at  DateTime @default(now())

  template Template @relation(fields: [template_id], references: [template_id])
}

model Purchase {
  purchase_id         String    @id @default(uuid())
  buyer_id            Int
  template_id         String
  amount_paid         Decimal
  currency            String
  purchase_date       DateTime  @default(now())
  transaction_id      String
  license_signed_url  String?
  downloaded          Boolean   @default(false)
  refund_status       String    @default("none")
  refund_requested_at DateTime?
  refunded_at         DateTime?

  buyer     User       @relation("BuyerPurchases", fields: [buyer_id], references: [user_id])
  template  Template   @relation(fields: [template_id], references: [template_id])
  payment   Payment?
  refund    Refund?
  downloads Download[]
}

model Payment {
  payment_id       String   @id @default(uuid())
  purchase_id      String   @unique
  gateway          String
  payment_method   String
  payment_status   String
  gateway_response Json
  created_at       DateTime @default(now())

  purchase Purchase @relation(fields: [purchase_id], references: [purchase_id])
}

model Refund {
  refund_id    String    @id @default(uuid())
  purchase_id  String    @unique
  requested_by Int
  reason       String
  status       String
  processed_by String?
  processed_at DateTime?
  created_at   DateTime  @default(now())

  purchase  Purchase @relation(fields: [purchase_id], references: [purchase_id])
  requester User     @relation("RefundRequester", fields: [requested_by], references: [user_id])
}

model Review {
  review_id   String   @id @default(uuid())
  user_id     Int
  template_id String
  rating      Int
  comment     String?
  created_at  DateTime @default(now())

  user     User     @relation(fields: [user_id], references: [user_id])
  template Template @relation(fields: [template_id], references: [template_id])
}

model AiEditSession {
  session_id      String    @id @default(uuid())
  user_id         Int
  template_id     String
  prompt_text     String
  edited_code_url String?
  preview_url     String?
  status          String
  cost_credits    Float?
  created_at      DateTime  @default(now())
  completed_at    DateTime?

  user     User     @relation(fields: [user_id], references: [user_id])
  template Template @relation(fields: [template_id], references: [template_id])
}

model Payout {
  payout_id     String    @id @default(uuid())
  creator_id    Int
  amount        Decimal
  period_start  DateTime
  period_end    DateTime
  payout_status String
  gateway_ref   String?
  created_at    DateTime  @default(now())
  completed_at  DateTime?

  creator User @relation("AuthorPayout", fields: [creator_id], references: [user_id])
}

model Download {
  download_id   String   @id @default(uuid())
  purchase_id   String
  user_id       Int
  template_id   String
  downloaded_at DateTime @default(now())
  ip_address    String

  purchase Purchase @relation(fields: [purchase_id], references: [purchase_id])
  user     User     @relation(fields: [user_id], references: [user_id])
  template Template @relation(fields: [template_id], references: [template_id])
}

model ReferralCode {
  code       String   @id
  user_id    Int
  uses       Int      @default(0)
  created_at DateTime @default(now())

  user User @relation(fields: [user_id], references: [user_id])
}

model AuthorTeamMember {
  id             String @id @default(uuid())
  author_user_id Int
  member_user_id Int
  permissions    Json

  author User @relation("AuthorToMembers", fields: [author_user_id], references: [user_id])
  member User @relation("MemberOfAuthors", fields: [member_user_id], references: [user_id])
}

model AdminTeamMember {
  id             String @id @default(uuid())
  admin_user_id  Int
  member_user_id Int
  role           String

  admin  User @relation("AdminToMembers", fields: [admin_user_id], references: [user_id])
  member User @relation("MemberOfAdmins", fields: [member_user_id], references: [user_id])
}

model AnalyticsEvent {
  event_id    String   @id @default(uuid())
  user_id     Int?
  template_id String?
  event_type  String
  meta        Json?
  created_at  DateTime @default(now())

  user     User?     @relation(fields: [user_id], references: [user_id])
  template Template? @relation(fields: [template_id], references: [template_id])
}

model Share {
  share_id    String   @id @default(uuid())
  user_id     Int
  template_id String
  channel     String
  created_at  DateTime @default(now())

  user     User     @relation(fields: [user_id], references: [user_id])
  template Template @relation(fields: [template_id], references: [template_id])
}
